---

- name: create squid home path
  file:
    path: "{{ SQUID_HOME }}"
    state: directory

- name: copy squid-deb-proxy configuration
  copy:
    src: squid-deb-proxy.conf
    dest: "{{ SQUID_HOME }}/squid-deb-proxy.conf"

- name: create squid-deb-proxy DVC
  become: yes
  docker:
    name: squid-deb-proxy-data
    image: pmoust/squid-deb-proxy
    volumes:
      - "{{ SQUID_HOME }}/squid-deb-proxy.conf:/etc/squid-deb-proxy/squid-deb-proxy.conf"
    state: present

- name: create squid-deb-proxy container
  become: yes
  docker:
    name: squid-deb-proxy
    image: pmoust/squid-deb-proxy
    ports:
      - "{{ acia_squid_port }}:8000"
    volumes_from:
      - squid-deb-proxy-data
    state: started
    restart_policy: "{{ 'always' if aci_install_type == 'server' else 'no' }}"

- name: add authorized_key for ansible-ci server on vagrant host
  authorized_key:
    user: "{{ acia_login_user }}"
    key: "{{ ACI_PUBLIC_KEY }}"

- name: create working directory
  file:
    path: "{{ WORKING_DIRECTORY }}"
    state: directory

- name: copy vagrantfile
  template:
    src: "{{ item }}.j2"
    dest: "{{ WORKING_DIRECTORY }}/{{ item }}"
  with_items:
    - Vagrantfile
    - bootstrap.sh
  when: acia_target_provider == 'vagrant'

- name: create vagrants authorized_keys to allow access from ACI server
  copy:
    content: "{{ ACI_PUBLIC_KEY }}"
    dest: "{{ WORKING_DIRECTORY }}/vagrant_authorized_key"
    mode: 0640

- name: create dedicated SSH private key for VM
  copy:
    content: "{{ ACIA_PRIVATE_KEY }}"
    dest: "{{ WORKING_DIRECTORY }}/id_rsa"
    mode: 0600

- name: copy docker mirror CA certificate to vagrant directory
  copy:
    src: "{{ DMIRROR_HOME }}/ca.pem"
    dest: "{{ WORKING_DIRECTORY }}/ca.crt"
    remote_src: yes
    mode: 0440

- name: copy ansible-ci-target script
  become: yes
  template:
    src: "ansible-ci-{{ acia_target_provider }}.j2"
    dest: /usr/local/bin/ansible-ci-target
    mode: 0755
